# リハビリテーション科 勤務表作成アプリ

## 1. 概要

このアプリケーションは、リハビリテーション科の複雑な勤務条件やスタッフの希望を考慮し、最適な勤務表を自動生成するPythonプログラムです。
StreamlitによるWebインターフェースを備えており、Googleの最適化ツール「OR-Tools」をバックエンドで利用しています。

- **バージョン**: `proto.2.3.3`
- **作者**: Okuno with 🤖 Gemini and Claude

## 2. 主な機能

- **Web UIによる簡単操作**: ブラウザ上で対象年月や各種パラメータ（ルールのON/OFF、ペナルティ値など）を直感的に設定できます。
- **Googleスプレッドシート連携**: 職員情報、希望休、保存した設定プリセットはすべてGoogleスプレッドシートで管理します。
- **柔軟なシフト作成ロジック**:
    - 月間休日数、希望休、役職者配置などの**基本ルール**を遵守します。
    - 週末の職種別人数、週休確保、業務負荷の平準化といった**ソフト制約**（努力目標）を考慮し、ペナルティが最小になる最適な解を探します。
- **設定プリセット機能**:
    - UI上で調整したパラメータ一式に名前を付けて、スプレッドシートに保存できます。
    - 保存した設定を後から簡単に読み込み、UIに反映させることができます。

## 3. セットアップと実行方法

### 必要なもの
1.  **Python環境**: `.venv` フォルダがあるため、仮想環境での実行が推奨されます。
2.  **ライブラリ**: `requirements.txt` に記載のライブラリ。
    ```bash
    pip install -r requirements.txt
    ```
3.  **Googleスプレッドシート**:
    - 以下の3つのシートを持つGoogleスプレッドシートが必要です。
        1.  `職員一覧`: スタッフの情報（職員番号、職種、役職など）を管理します。
        2.  `希望休一覧`: 各スタッフの希望休を月ごとに管理します。
        3.  `設定プリセット`: UIのパラメータ設定を保存・読み込みするためのシート。
    - StreamlitのSecrets機能を使って、Googleサービスアカウントの認証情報（JSON）を設定する必要があります。

### 実行
以下のコマンドでアプリケーションを起動します。

```bash
streamlit run reha-shift-proto2.py
```

## 4. 最近の主な更新履歴 (proto.2.3.x)

- **設定プリセット機能の追加**:
  - UI上のすべてのパラメータ設定（ルールのON/OFF、ペナルティ値、目標人数など）を名前付きでGoogleスプレッドシート (`設定プリセット`シート) に保存・読み込みできる機能を追加しました。
  - 設定はJSON形式で保存されます。
- **`st.session_state`の活用**:
  - Streamlitの`session_state`を利用してUIの状態を管理するようにコードを改善し、設定読み込み時の画面反映やウィジェット間の連動をより安定させました。
- **UIレイアウトの改善**:
  - パラメータの役割が直感的に分かりやすくなるよう、UI上の配置を見直しました。
    - （例：「PT/OT許容誤差」を「週末の出勤人数設定」セクションに移動）
  - 紛らわしい重複した設定項目を削除し、設定をルール検証モードに一元化しました。
